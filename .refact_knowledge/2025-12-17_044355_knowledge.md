---
title: "---"
created: 2025-12-17
tags: ["architecture", "ast", "treesitter", "parsers", "tests", "kotlin", "refact-agent"]
---

---
title: \"Kotlin Tree-sitter Parser Test Cases\"
created: 2025-12-17
tags: [\"architecture\", \"ast\", \"treesitter\", \"parsers\", \"tests\", \"kotlin\", \"refact-agent\"]
---

### Kotlin Tree-sitter Parser Test Cases

**• Purpose:**  
This directory contains test fixtures (sample Kotlin source files and their expected outputs) for validating the Kotlin Tree-sitter parser within refact-agent's AST system. It ensures accurate syntax tree generation, symbol extraction (declarations/definitions), and skeletonization (structure-only versions without implementation details). These tests support Kotlin-specific code intelligence features like \"go to definition\" (`at_ast_definition.rs`), \"find references\" (`at_ast_reference.rs`), and incremental indexing (`ast_parse_anything.rs`, `ast_indexer_thread.rs`) in the LSP server. As part of the multi-language AST layer, it enables reliable parsing for JVM ecosystems, feeding into agentic tools, HTTP/LSP handlers, and VecDB indexing.

**• Files:**  
```
kotlin/
├── main.kt                     # Sample Kotlin source: entry point testing functions, classes, companions, or top-level declarations
├── main.kt.json                # Expected JSON: full AST parse or symbol info (e.g., function signatures, imports)
├── person.kt                   # Sample Kotlin source: class/data class definitions, properties, constructors, extensions
├── person.kt.decl_json         # Expected JSON: extracted declarations/symbol table (fields, methods, overrides)
├── person.kt.json              # Expected JSON: complete parse/symbol info for person.kt (complements decl_json)
└── person.kt.skeleton          # Expected skeleton: structure-only (signatures, hierarchy; no bodies)
```
- **Organization pattern**: Follows the consistent golden testing format across `cases/` siblings (`cpp/`, `java/`, `js/`, `python/`, `rust/`, `ts/`): each `.kt` source pairs with `.json` (parse/symbols), `.decl_json` (declarations), and `.skeleton` files. Loaded by `tests/kotlin.rs` for automated validation.

**• Architecture:**  
- **Design patterns**: Golden file testing (actual vs. expected outputs for parser stability); language isolation in `parsers/kotlin.rs`; incremental validation for live IDE updates. Fits refact-agent's layered architecture: AST layer (`treesitter/`) → AT commands/tools → HTTP/LSP handlers (`http/routers/v1/ast.rs`) → agentic features.
- **Relationships**: Sibling to `java/` (similar OO/JVM patterns like classes/methods); uses `language_id.rs::Kotlin`; outputs feed `ast_structs.rs::Node`, `skeletonizer.rs`. Unlike broader `alt_testsuite/` (annotated edge cases), this focuses on core parser accuracy.
- **Comparison to existing knowledge**: Directly analogous to Java/JS test cases—same structure (`person.java`/`car.js` → `person.kt`), building on \"Tree-sitter integration for 6+ languages\" by adding Kotlin-specific fixtures. Unlike runtime indexing, pure validation via `tests/kotlin.rs`. Introduces JVM language consistency, enabling cross-lang symbol resolution.

**• Key Symbols:**  
| Symbol/Path                  | Purpose                                      |
|------------------------------|----------------------------------------------|
| `ast_structs.rs::Node`       | Parsed AST node storage                      |
| `language_id.rs::Kotlin`     | Language detection/enum                      |
| `parsers/kotlin.rs`          | Kotlin-specific Tree-sitter grammar/queries  |
| `skeletonizer.rs`            | Generates `.skeleton` (structure extraction) |
| `tests/kotlin.rs`            | Test runner loading these fixtures           |
| `file_ast_markup.rs`         | Markup/symbol extraction from parse trees    |

**• Integration:**  
- **Uses**: Tree-sitter external crate; core AST utils (`parse_common.rs`, `ast_instance_structs.rs`).
- **Used by**: `at_ast_definition.rs`, `at_ast_reference.rs` (navigation tools); `ast_indexer_thread.rs` (background indexing); LSP handlers (`lsp_like_handlers.rs`); VecDB (`vecdb/` for code search).
- **Communication**: Fixtures → `tests/kotlin.rs` → parser validation → runtime AST feeds (`ast_db.rs`). Supports multi-lang workspace analysis via `ast_parse_anything.rs`.
- **Extension points**: New fixtures easily added for Kotlin features (coroutines, sealed classes); pattern extensible to other langs. Error handling via `custom_error.rs` patterns in parser layer.
